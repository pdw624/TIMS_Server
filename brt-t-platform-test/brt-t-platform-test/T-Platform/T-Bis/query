// 정류장 도착시
SELECT T1.ROUTE_ID,
    T2.GPS_DT,
    T1.EVENT_DATA AS ST_NODE_ID,
    T2.EVENT_DATA AS ED_NODE_ID,
    T1.LINK_ID AS PREV_LINK_ID,
    T2.LINK_ID AS CURR_LINK_ID,
    T2.RUN_TYPE,
    DATEDIFF('SECOND', T1.GPS_DT, T2.GPS_DT) AS GAP_DT
FROM (
    SELECT ROUTE_ID, LINK_ID, EVENT_DATA, RUN_TYPE, parsedatetime(GPS_DT, 'yyyyMMddHHmmssSS') AS GPS_DT
    FROM BIS_HT_BUS_EVENT
    WHERE (GPS_DT < '2017082909370000' AND GPS_DT > '2017082900000000')
    AND BUS_ID = 'V000000003'
    AND ROUTE_ID = 'R000000001'
    AND EVENT_CD IN (2, 3, 7, 8)
    ORDER BY GPS_DT DESC
    LIMIT 1
) T1, (
    SELECT ROUTE_ID, LINK_ID, EVENT_DATA, RUN_TYPE, parsedatetime(GPS_DT, 'yyyyMMddHHmmssSS') AS GPS_DT
    FROM BIS_HT_BUS_EVENT
    WHERE GPS_DT = '2017082909370000'
    AND BUS_ID = 'V000000003'
    AND ROUTE_ID = 'R000000001'
    AND EVENT_CD IN (1)
) T2
WHERE T1.ROUTE_ID = T2.ROUTE_ID

// 시작노드와 끝노드로 링크 아이디 뽑아내기
SELECT LINK_ID, LINK_LENGTH
FROM BIS_MT_LINK
WHERE FROM_NODE_ID = 'nc100093' AND TO_NODE_ID = 'ns100003'

// 정류장 도착시 링크 아이디 뽑아내기
SELECT LINK_ID
FROM BIS_MT_LINK
WHERE FROM_NODE_ID = (
    SELECT EVENT_DATA
    FROM BIS_HT_BUS_EVENT
    WHERE GPS_DT < '2017082909370000'
    AND BUS_ID = 'V000000003'
    AND EVENT_CD IN (2, 3, 7, 8)
    ORDER BY GPS_DT DESC
    LIMIT 1
) AND TO_NODE_ID = (
    SELECT EVENT_DATA
    FROM BIS_HT_BUS_EVENT
    WHERE GPS_DT = '2017082909370000'
    AND BUS_ID = 'V000000003'
    AND EVENT_CD IN (1)
)
